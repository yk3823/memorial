{% extends "base_rtl.html" %}

{% block title %}רשימת הנצחות - {% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1 class="display-5 hebrew-title mb-2">
                        <i class="bi bi-heart-fill text-primary me-2"></i>
                        ההנצחות שלי
                    </h1>
                    <p class="lead hebrew-text text-muted">נהל את כל דפי ההנצחה שיצרת</p>
                </div>
                <div>
                    <a href="/he/memorial/new" class="btn btn-primary btn-lg hebrew-text">
                        <i class="bi bi-plus-circle me-2"></i>צור הנצחה חדשה
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-container">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control search-input hebrew-input" 
                                   id="searchInput" placeholder="חפש לפי שם, תאריך או תוכן..." dir="rtl">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select hebrew-text" id="sortSelect">
                            <option value="newest">חדשים ביותר</option>
                            <option value="oldest">ישנים ביותר</option>
                            <option value="name_hebrew">לפי שם עברי</option>
                            <option value="death_date">לפי תאריך פטירה</option>
                            <option value="most_viewed">הצפויים ביותר</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="btn-group" role="group" aria-label="מסנני תצוגה">
                            <input type="radio" class="btn-check" name="viewFilter" id="all" value="all" checked>
                            <label class="btn btn-outline-primary hebrew-text" for="all">
                                <i class="bi bi-grid me-1"></i>הכל
                            </label>
                            
                            <input type="radio" class="btn-check" name="viewFilter" id="public" value="public">
                            <label class="btn btn-outline-primary hebrew-text" for="public">
                                <i class="bi bi-globe me-1"></i>ציבורי
                            </label>
                            
                            <input type="radio" class="btn-check" name="viewFilter" id="private" value="private">
                            <label class="btn btn-outline-primary hebrew-text" for="private">
                                <i class="bi bi-lock me-1"></i>פרטי
                            </label>
                            
                            <input type="radio" class="btn-check" name="viewFilter" id="recent" value="recent">
                            <label class="btn btn-outline-primary hebrew-text" for="recent">
                                <i class="bi bi-clock me-1"></i>אחרונים
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Memorial Cards -->
    <div class="row" id="memorialsList">
        <!-- Memorial cards will be loaded here by JavaScript -->
    </div>

    <!-- Empty State -->
    <div class="row d-none" id="emptyState">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-heart display-1 text-muted"></i>
                <h3 class="hebrew-title mt-4">עדיין אין הנצחות</h3>
                <p class="lead hebrew-text text-muted">צור את ההנצחה הראשונה שלך עם פסוקי תהילים קיט</p>
                <a href="/he/memorial/new" class="btn btn-primary btn-lg hebrew-text mt-3">
                    <i class="bi bi-plus-circle me-2"></i>צור הנצחה ראשונה
                </a>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="row d-none" id="loadingState">
        <div class="col-12">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">טוען...</span>
                </div>
                <p class="hebrew-text text-muted mt-3">טוען הנצחות...</p>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="ניווט בין עמודים" id="paginationNav" class="d-none">
                <ul class="pagination justify-content-center" id="paginationList">
                    <!-- Pagination will be loaded here by JavaScript -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Memorial Actions Modal -->
<div class="modal fade" id="memorialActionsModal" tabindex="-1" aria-labelledby="memorialActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title hebrew-title" id="memorialActionsModalLabel">פעולות על ההנצחה</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="סגור"></button>
            </div>
            <div class="modal-body hebrew-text" id="modalBody">
                <!-- Modal content will be loaded by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const memorialsList = document.getElementById('memorialsList');
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const viewFilters = document.querySelectorAll('input[name="viewFilter"]');
    const paginationNav = document.getElementById('paginationNav');
    const paginationList = document.getElementById('paginationList');
    
    let memorials = [];
    let currentPage = 1;
    let memorialsPerPage = 12;
    let searchTimeout;

    // Load memorials on page load
    loadMemorials();

    // Search functionality with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            filterAndDisplayMemorials();
        }, 300);
    });

    // Sort and filter handlers
    sortSelect.addEventListener('change', () => {
        currentPage = 1;
        filterAndDisplayMemorials();
    });

    viewFilters.forEach(filter => {
        filter.addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayMemorials();
        });
    });

    // Load memorials from API
    async function loadMemorials() {
        try {
            showLoadingState();
            
            console.log('Making API call to /memorials/my...');
            const response = await HebrewMemorialApp.apiCall('/memorials/my');
            console.log('Raw API response:', response);
            console.log('Response type:', typeof response);
            console.log('Response keys:', response ? Object.keys(response) : 'null');
            
            // Handle different response formats
            if (response.items) {
                memorials = response.items;
                console.log('Using response.items, count:', response.items.length);
            } else if (response.memorials) {
                memorials = response.memorials;
                console.log('Using response.memorials, count:', response.memorials.length);
            } else if (Array.isArray(response)) {
                memorials = response;
                console.log('Using array response, count:', response.length);
            } else {
                memorials = [];
                console.log('No valid memorial data found, setting empty array');
            }
            
            hideLoadingState();
            console.log('Final memorials array:', memorials);
            console.log('Number of memorials:', memorials.length);
            filterAndDisplayMemorials();
            
        } catch (error) {
            console.error('API Error:', error);
            console.error('Error type:', typeof error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            // Check authentication status
            const token = localStorage.getItem('access_token');
            console.log('localStorage access_token:', token ? 'exists' : 'missing');
            
            hideLoadingState();
            
            // Handle different error types
            let errorMessage = 'שגיאה בטעינת ההנצחות. אנא רענן את הדף.';
            
            if (error.message) {
                // Extract more specific error information
                if (error.message.includes('401')) {
                    errorMessage = 'יש להתחבר כדי לצפות בהנצחות שלך. אנא התחבר מחדש.';
                    // Redirect to login after delay
                    setTimeout(() => {
                        window.location.href = '/he/login';
                    }, 2000);
                } else if (error.message.includes('422')) {
                    errorMessage = 'שגיאת אימות. אנא התחבר מחדש ונסה שנית.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'אין הרשאה לצפות בתוכן זה.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'השירות אינו זמין כעת.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'שגיאה בשרת. אנא נסה שנית מאוחר יותר.';
                }
            }
            
            HebrewMemorialApp.showError(errorMessage);
        }
    }

    // Filter and display memorials
    function filterAndDisplayMemorials() {
        console.log('filterAndDisplayMemorials called with:', memorials.length, 'memorials');
        let filteredMemorials = [...memorials];
        
        // Search filter
        const searchTerm = searchInput.value.trim().toLowerCase();
        console.log('Search term:', searchTerm);
        if (searchTerm) {
            filteredMemorials = filteredMemorials.filter(memorial => {
                return memorial.deceased_name_hebrew.toLowerCase().includes(searchTerm) ||
                       (memorial.deceased_name_english && memorial.deceased_name_english.toLowerCase().includes(searchTerm)) ||
                       (memorial.biography && memorial.biography.toLowerCase().includes(searchTerm));
            });
        }
        
        // View filter
        const selectedViewFilter = document.querySelector('input[name="viewFilter"]:checked').value;
        if (selectedViewFilter !== 'all') {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            filteredMemorials = filteredMemorials.filter(memorial => {
                switch (selectedViewFilter) {
                    case 'public':
                        return memorial.is_public;
                    case 'private':
                        return !memorial.is_public;
                    case 'recent':
                        return new Date(memorial.created_at) > oneWeekAgo;
                    default:
                        return true;
                }
            });
        }
        
        // Sort
        const sortBy = sortSelect.value;
        filteredMemorials.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return new Date(b.created_at) - new Date(a.created_at);
                case 'oldest':
                    return new Date(a.created_at) - new Date(b.created_at);
                case 'name_hebrew':
                    return a.deceased_name_hebrew.localeCompare(b.deceased_name_hebrew, 'he');
                case 'death_date':
                    const dateA = a.death_date_gregorian ? new Date(a.death_date_gregorian) : new Date(0);
                    const dateB = b.death_date_gregorian ? new Date(b.death_date_gregorian) : new Date(0);
                    return dateB - dateA;
                case 'most_viewed':
                    return (b.page_views || 0) - (a.page_views || 0);
                default:
                    return 0;
            }
        });
        
        displayMemorials(filteredMemorials);
        setupPagination(filteredMemorials);
    }

    // Display memorials
    function displayMemorials(memorialsArray) {
        console.log('displayMemorials called with:', memorialsArray.length, 'memorials');
        console.log('Memorials to display:', memorialsArray);
        
        if (memorialsArray.length === 0) {
            console.log('No memorials to display, showing empty state');
            showEmptyState();
            return;
        }
        
        console.log('Will render', memorialsArray.length, 'memorials');
        
        hideEmptyState();
        
        // Calculate pagination
        const startIndex = (currentPage - 1) * memorialsPerPage;
        const endIndex = startIndex + memorialsPerPage;
        const paginatedMemorials = memorialsArray.slice(startIndex, endIndex);
        
        const memorialsHtml = paginatedMemorials.map(memorial => createMemorialCard(memorial)).join('');
        memorialsList.innerHTML = memorialsHtml;
    }

    // Create memorial card HTML
    function createMemorialCard(memorial) {
        const hebrewDates = getHebrewDates(memorial);
        const age = calculateAge(memorial.birth_date_gregorian, memorial.death_date_gregorian);
        const timeAgo = getTimeAgo(memorial.created_at);
        
        return `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card memorial-card h-100">
                    <div class="memorial-header">
                        <h5 class="memorial-name">${memorial.deceased_name_hebrew}</h5>
                        ${memorial.deceased_name_english ? `<div class="memorial-name-english">${memorial.deceased_name_english}</div>` : ''}
                        <div class="memorial-dates">
                            ${hebrewDates}
                            ${age ? `<div class="small mt-1">בן ${age} שנים</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="badge ${memorial.is_public ? 'bg-success' : 'bg-secondary'}">
                                    <i class="bi bi-${memorial.is_public ? 'globe' : 'lock'} me-1"></i>
                                    ${memorial.is_public ? 'ציבורי' : 'פרטי'}
                                </span>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            
                            ${memorial.biography ? `
                                <p class="card-text text-muted small">
                                    ${memorial.biography.length > 100 ? memorial.biography.substring(0, 100) + '...' : memorial.biography}
                                </p>
                            ` : ''}
                        </div>
                        
                        <div class="row text-center mb-3 small">
                            <div class="col-4">
                                <i class="bi bi-eye text-primary"></i>
                                <div>${memorial.page_views || 0}</div>
                                <small class="text-muted">צפיות</small>
                            </div>
                            <div class="col-4">
                                <i class="bi bi-book text-success"></i>
                                <div>${memorial.psalm_verses_count || 0}</div>
                                <small class="text-muted">פסוקים</small>
                            </div>
                            <div class="col-4">
                                <i class="bi bi-images text-info"></i>
                                <div>${memorial.photos_count || 0}</div>
                                <small class="text-muted">תמונות</small>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <div class="d-grid gap-2">
                                <a href="/he/memorial/${memorial.unique_slug}" class="btn btn-primary hebrew-text">
                                    <i class="bi bi-eye me-1"></i>צפה בהנצחה
                                </a>
                                <div class="btn-group" role="group">
                                    <a href="/he/memorial/${memorial.unique_slug}/edit" class="btn btn-outline-secondary btn-sm hebrew-text">
                                        <i class="bi bi-pencil"></i>ערוך
                                    </a>
                                    ${memorial.public_url ? `
                                        <button type="button" class="btn btn-outline-info btn-sm hebrew-text" 
                                                onclick="copyToClipboard('${window.location.origin}${memorial.public_url}')">
                                            <i class="bi bi-share"></i>שתף
                                        </button>
                                    ` : ''}
                                    <button type="button" class="btn btn-outline-danger btn-sm hebrew-text" 
                                            onclick="showMemorialActions('${memorial.id}', '${memorial.deceased_name_hebrew}')">
                                        <i class="bi bi-three-dots"></i>עוד
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Helper functions
    function getHebrewDates(memorial) {
        let dates = '';
        
        if (memorial.birth_date_hebrew || memorial.birth_date_gregorian) {
            const birthDate = memorial.birth_date_hebrew || formatDate(memorial.birth_date_gregorian);
            dates += birthDate;
        }
        
        if (memorial.death_date_hebrew || memorial.death_date_gregorian) {
            const deathDate = memorial.death_date_hebrew || formatDate(memorial.death_date_gregorian);
            dates += (dates ? ' - ' : '') + deathDate;
        }
        
        return dates || 'תאריכים לא זמינים';
    }

    function calculateAge(birthDate, deathDate) {
        if (!birthDate || !deathDate) return null;
        
        const birth = new Date(birthDate);
        const death = new Date(deathDate);
        const ageInMs = death - birth;
        const ageInYears = Math.floor(ageInMs / (365.25 * 24 * 60 * 60 * 1000));
        
        return ageInYears > 0 ? ageInYears : null;
    }

    function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInMs = now - date;
        const diffInDays = Math.floor(diffInMs / (24 * 60 * 60 * 1000));
        
        if (diffInDays === 0) return 'היום';
        if (diffInDays === 1) return 'אתמול';
        if (diffInDays < 7) return `לפני ${diffInDays} ימים`;
        if (diffInDays < 30) return `לפני ${Math.floor(diffInDays / 7)} שבועות`;
        if (diffInDays < 365) return `לפני ${Math.floor(diffInDays / 30)} חודשים`;
        return `לפני ${Math.floor(diffInDays / 365)} שנים`;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('he-IL');
    }

    // Setup pagination
    function setupPagination(memorialsList) {
        const totalPages = Math.ceil(memorialsList.length / memorialsPerPage);
        
        if (totalPages <= 1) {
            paginationNav.classList.add('d-none');
            return;
        }
        
        paginationNav.classList.remove('d-none');
        
        let paginationHtml = '';
        
        // Previous button
        paginationHtml += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link hebrew-text" href="#" onclick="changePage(${currentPage - 1})">קודם</a>
            </li>
        `;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // Next button
        paginationHtml += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link hebrew-text" href="#" onclick="changePage(${currentPage + 1})">הבא</a>
            </li>
        `;
        
        paginationList.innerHTML = paginationHtml;
    }

    // Page change handler
    window.changePage = function(page) {
        const totalPages = Math.ceil(memorials.length / memorialsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        filterAndDisplayMemorials();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Copy to clipboard function
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            HebrewMemorialApp.showSuccess('הקישור הועתק ללוח');
        }).catch(() => {
            HebrewMemorialApp.showError('שגיאה בהעתקת הקישור');
        });
    };

    // Memorial actions modal
    window.showMemorialActions = function(memorialId, memorialName) {
        const modal = new bootstrap.Modal(document.getElementById('memorialActionsModal'));
        const modalBody = document.getElementById('modalBody');
        
        modalBody.innerHTML = `
            <p class="hebrew-text">בחר פעולה עבור הנצחת <strong>${memorialName}</strong>:</p>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-outline-warning hebrew-text" onclick="toggleMemorialVisibility('${memorialId}')">
                    <i class="bi bi-eye-slash me-2"></i>שנה רמת פרטיות
                </button>
                <button type="button" class="btn btn-outline-info hebrew-text" onclick="duplicateMemorial('${memorialId}')">
                    <i class="bi bi-files me-2"></i>צור עותק
                </button>
                <button type="button" class="btn btn-outline-secondary hebrew-text" onclick="exportMemorial('${memorialId}')">
                    <i class="bi bi-download me-2"></i>ייצא לPDF
                </button>
                <hr>
                <button type="button" class="btn btn-outline-danger hebrew-text" onclick="deleteMemorial('${memorialId}', '${memorialName}')">
                    <i class="bi bi-trash me-2"></i>מחק הנצחה
                </button>
            </div>
        `;
        
        modal.show();
    };

    // Memorial action handlers
    window.toggleMemorialVisibility = async function(memorialId) {
        try {
            await HebrewMemorialApp.apiCall(`/memorials/${memorialId}/toggle-visibility`, {
                method: 'PATCH'
            });
            
            HebrewMemorialApp.showSuccess('רמת הפרטיות שונתה בהצלחה');
            loadMemorials(); // Reload memorials
            
        } catch (error) {
            HebrewMemorialApp.showError('שגיאה בשינוי רמת הפרטיות');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('memorialActionsModal')).hide();
    };

    window.deleteMemorial = function(memorialId, memorialName) {
        if (confirm(`האם אתה בטוח שברצונך למחוק את הנצחת "${memorialName}"? פעולה זו לא ניתנת לביטול.`)) {
            performDeleteMemorial(memorialId);
        }
    };

    async function performDeleteMemorial(memorialId) {
        try {
            await HebrewMemorialApp.apiCall(`/memorials/${memorialId}`, {
                method: 'DELETE'
            });
            
            HebrewMemorialApp.showSuccess('ההנצחה נמחקה בהצלחה');
            loadMemorials(); // Reload memorials
            
        } catch (error) {
            HebrewMemorialApp.showError('שגיאה במחיקת ההנצחה');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('memorialActionsModal')).hide();
    }

    // Utility functions
    function showLoadingState() {
        loadingState.classList.remove('d-none');
        memorialsList.innerHTML = '';
        emptyState.classList.add('d-none');
        paginationNav.classList.add('d-none');
    }

    function hideLoadingState() {
        loadingState.classList.add('d-none');
    }

    function showEmptyState() {
        emptyState.classList.remove('d-none');
        memorialsList.innerHTML = '';
        paginationNav.classList.add('d-none');
    }

    function hideEmptyState() {
        emptyState.classList.add('d-none');
    }
});
</script>
{% endblock %}