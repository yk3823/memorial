{% extends "base_rtl.html" %}

{% block title %}הנצחה - {{ memorial_slug }} - {% endblock %}

{% block extra_css %}
<style>
    .memorial-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .memorial-photo {
        border-radius: 50%;
        border: 5px solid white;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        width: 200px;
        height: 200px;
        object-fit: cover;
    }
    
    .biography {
        line-height: 1.8;
        text-align: justify;
        font-size: 1.1rem;
    }
    
    .date-card {
        background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 0.75rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card {
        background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 0.75rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Hebrew verses styling */
    .verse-section {
        margin-bottom: 1.2rem;
        border-radius: 1rem;
        border: 2px solid #e9ecef;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .verse-section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }
    
    .neshama-verse-section-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .verse-letter-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .verse-letter-name {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .verse-container {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 0.8rem 1rem;
        transition: background-color 0.3s ease;
    }
    
    .verse-container:hover {
        background: #f8f9fa;
    }
    
    .verse-container:last-child {
        border-bottom: none;
    }
    
    .verse-number {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .verse-hebrew {
        font-size: 1.4rem;
        line-height: 1.8;
        color: #2c3e50;
        margin-bottom: 1rem;
        text-align: right;
        font-family: 'David Libre', serif;
    }
    
    .verse-transliteration {
        font-size: 1.1rem;
        color: #6c757d;
        margin-bottom: 0.8rem;
        font-style: italic;
        text-align: right;
    }
    
    .verse-english {
        font-size: 1rem;
        color: #495057;
        line-height: 1.6;
        text-align: left;
        direction: ltr;
    }
    
    .verses-loading {
        text-align: center;
        padding: 3rem;
    }
    
    .verses-loading .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .neshama-separator {
        margin: 3rem 0;
        text-align: center;
    }
    
    .neshama-separator hr {
        border: none;
        height: 3px;
        background: linear-gradient(90deg, transparent, #f093fb, transparent);
        margin: 1rem 0;
    }
    
    .neshama-title {
        font-size: 2rem;
        color: #f093fb;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .neshama-subtitle {
        font-size: 1.2rem;
        color: #6c757d;
    }

    @media (max-width: 768px) {
        .verse-letter-title {
            font-size: 2rem;
        }
        
        .verse-hebrew {
            font-size: 1.2rem;
        }
        
        .verse-transliteration {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="memorialContent">
    <!-- Loading spinner -->
    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border spinner-border-lg text-primary" role="status">
            <span class="visually-hidden">טוען דף הנצחה...</span>
        </div>
        <p class="mt-3 text-muted hebrew-text">טוען דף הנצחה...</p>
    </div>
    
    <!-- Error state -->
    <div id="errorState" class="d-none">
        <div class="text-center py-5">
            <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
            <h2 class="hebrew-title">הנצחה לא נמצאה</h2>
            <p class="text-muted mb-4 hebrew-text">דף ההנצחה המבוקש לא נמצא או שהוא פרטי.</p>
            <a href="/he" class="btn btn-primary hebrew-text">
                <i class="bi bi-house me-2"></i>חזרה לבית
            </a>
        </div>
    </div>
    
    <!-- Memorial content template -->
    <div id="memorialTemplate" class="d-none">
        <!-- Hero Section -->
        <div class="memorial-hero p-5 text-center">
            <div class="row align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="memorial-photo-container">
                        <img id="memorialPhoto" src="/static/images/default-avatar.png" 
                             alt="תמונת הנצחה" class="memorial-photo">
                    </div>
                </div>
                <div class="col-md-8">
                    <h1 class="display-4 mb-2 hebrew-title" id="memorialNameHebrew">שם עברי</h1>
                    <h2 class="h4 mb-3" id="memorialNameEnglish">English Name</h2>
                    <div class="row text-center">
                        <div class="col-md-6 mb-3">
                            <div class="date-card p-3">
                                <i class="bi bi-calendar-heart display-6 mb-2"></i>
                                <h6 class="mb-1 hebrew-text">נולד</h6>
                                <p class="mb-0" id="birthDate">תאריך</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stats-card p-3">
                                <i class="bi bi-calendar-x display-6 mb-2"></i>
                                <h6 class="mb-1 hebrew-text">נפטר</h6>
                                <p class="mb-0" id="deathDate">תאריך</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <ul class="nav nav-pills nav-justified mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active hebrew-text" id="biography-tab" data-bs-toggle="pill" 
                        data-bs-target="#biography" type="button">
                    <i class="bi bi-book me-2"></i>סיפור החיים
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link hebrew-text" id="verses-tab" data-bs-toggle="pill" 
                        data-bs-target="#verses" type="button">
                    <i class="bi bi-star-of-david me-2"></i>פסוקי תהילים
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link hebrew-text" id="photos-tab" data-bs-toggle="pill" 
                        data-bs-target="#photos" type="button">
                    <i class="bi bi-images me-2"></i>תמונות
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link hebrew-text" id="yahrzeit-tab" data-bs-toggle="pill" 
                        data-bs-target="#yahrzeit" type="button">
                    <i class="bi bi-calendar-heart me-2"></i>יארצייט
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Biography Tab -->
            <div class="tab-pane fade show active" id="biography" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title hebrew-title">
                            <i class="bi bi-book me-2"></i>סיפור החיים
                        </h5>
                        <div class="biography hebrew-text" id="memorialBiography">
                            <p>טוען ביוגרפיה...</p>
                        </div>
                        
                        <!-- Memorial Song/Video -->
                        <div id="memorialMedia" class="mt-4 d-none">
                            <h6 class="hebrew-text"><i class="bi bi-music-note me-2"></i>שיר הנצחה</h6>
                            <div class="ratio ratio-16x9">
                                <iframe id="memorialVideo" src="" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Verses Tab - CRITICAL IMPLEMENTATION -->
            <div class="tab-pane fade" id="verses" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title hebrew-title text-center">
                            <i class="bi bi-star-of-david me-2"></i>פסוקי תהילים קיט לפי השם העברי
                        </h5>
                        <p class="text-center text-muted hebrew-text mb-4">
                            פסוקים מתהילים קיט המותאמים לכל אות בשם העברי ופסוקי נשמה
                        </p>
                        
                        <!-- Verses Loading -->
                        <div id="versesLoading" class="verses-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">טוען פסוקים...</span>
                            </div>
                            <p class="mt-3 hebrew-text">טוען פסוקי תהילים...</p>
                        </div>
                        
                        <!-- Verses Content -->
                        <div id="versesContent" class="d-none">
                            <!-- Name verses will be loaded here -->
                            <div id="nameVersesContainer"></div>
                            
                            <!-- Neshama separator -->
                            <div class="neshama-separator">
                                <div class="neshama-title hebrew-text">פסוקי נשמה</div>
                                <div class="neshama-subtitle hebrew-text">פסוקים מיוחדים לעילוי הנשמה - נ.ש.מ.ה</div>
                                <hr>
                            </div>
                            
                            <!-- Neshama verses will be loaded here -->
                            <div id="neshamaVersesContainer"></div>
                        </div>
                        
                        <!-- Error state for verses -->
                        <div id="versesError" class="d-none">
                            <div class="text-center py-4">
                                <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                                <h4 class="hebrew-text">שגיאה בטעינת הפסוקים</h4>
                                <p class="hebrew-text text-muted">לא ניתן לטעון את פסוקי התהילים כרגע</p>
                                <button class="btn btn-primary hebrew-text" onclick="loadMemorialVerses()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>נסה שוב
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Photos Tab -->
            <div class="tab-pane fade" id="photos" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title hebrew-title">
                            <i class="bi bi-images me-2"></i>גלריית תמונות
                        </h5>
                        <div id="photoGallery" class="row g-3">
                            <!-- Photos will be loaded here -->
                        </div>
                        <div id="noPhotos" class="text-center py-4 text-muted d-none">
                            <i class="bi bi-images display-4 mb-3"></i>
                            <p class="hebrew-text">עדיין לא הוספו תמונות.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yahrzeit Tab -->
            <div class="tab-pane fade" id="yahrzeit" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title hebrew-title">
                            <i class="bi bi-calendar-heart me-2"></i>פרטי יארצייט
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title hebrew-text">תאריך פטירה עברי</h6>
                                        <p class="card-text hebrew-text h5" id="hebrewDeathDate">
                                            תאריך עברי לא זמין
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title hebrew-text">יארצייט הבא</h6>
                                        <p class="card-text h5" id="nextYahrzeit">
                                            מחשב...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-5 py-4 border-top">
            <p class="text-muted mb-2 hebrew-text">
                <i class="bi bi-eye me-2"></i>
                נצפה <span id="viewCount">0</span> פעמים
            </p>
            <p class="small text-muted hebrew-text">
                הנצחה נוצרה ב<span id="createdDate">תאריך</span>
            </p>
            
            <!-- Share buttons -->
            <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm me-2 hebrew-text" onclick="shareMemorial()">
                    <i class="bi bi-share me-1"></i>שתף
                </button>
                {% if current_user %}
                <a href="/he/memorial/new" class="btn btn-primary btn-sm hebrew-text">
                    <i class="bi bi-plus-circle me-1"></i>צור הנצחה
                </a>
                {% else %}
                <a href="/he/register" class="btn btn-primary btn-sm hebrew-text">
                    <i class="bi bi-person-plus me-1"></i>צור חשבון
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const memorialSlug = '{{ memorial_slug }}';
    loadMemorial(memorialSlug);
});

let currentMemorial = null;

async function loadMemorial(slug) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorState = document.getElementById('errorState');
    const memorialTemplate = document.getElementById('memorialTemplate');
    
    try {
        console.log('Loading memorial for slug:', slug);
        
        // Try the API endpoint first
        const response = await fetch(`/api/v1/memorials/${slug}/public`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const memorial = await response.json();
        currentMemorial = memorial;
        console.log('Memorial loaded:', memorial);
        
        displayMemorial(memorial);
        
    } catch (error) {
        console.error('Failed to load memorial:', error);
        loadingSpinner.classList.add('d-none');
        errorState.classList.remove('d-none');
    }
}

function displayMemorial(memorial) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const memorialTemplate = document.getElementById('memorialTemplate');
    
    console.log('Displaying memorial data:', memorial);
    
    // Update page title
    const hebrewName = memorial.deceased_name_hebrew || 'הנצחה';
    document.title = `הנצחה - ${hebrewName}`;
    
    // Fill in memorial data with Hebrew priority
    const memorialNameHebrew = document.getElementById('memorialNameHebrew');
    const memorialNameEnglish = document.getElementById('memorialNameEnglish');
    
    if (memorial.deceased_name_hebrew) {
        memorialNameHebrew.textContent = memorial.deceased_name_hebrew;
        memorialNameHebrew.style.display = 'block';
    } else {
        memorialNameHebrew.style.display = 'none';
    }
    
    if (memorial.deceased_name_english) {
        memorialNameEnglish.textContent = memorial.deceased_name_english;
        memorialNameEnglish.style.display = 'block';
    } else {
        memorialNameEnglish.style.display = 'none';
    }
    
    // Dates
    document.getElementById('birthDate').textContent = memorial.birth_date_gregorian ? 
        formatHebrewDate(memorial.birth_date_gregorian) : 'לא צוין';
    document.getElementById('deathDate').textContent = memorial.death_date_gregorian ?
        formatHebrewDate(memorial.death_date_gregorian) : 'לא צוין';
    
    // Biography
    const biographyElement = document.getElementById('memorialBiography');
    if (memorial.biography) {
        biographyElement.innerHTML = memorial.biography.replace(/\n/g, '<br>');
    } else {
        biographyElement.innerHTML = '<p class="text-muted hebrew-text">לא הוספה ביוגרפיה.</p>';
    }
    
    // Stats
    document.getElementById('viewCount').textContent = memorial.page_views || 0;
    document.getElementById('createdDate').textContent = memorial.created_at ? 
        formatHebrewDate(memorial.created_at.split('T')[0]) : 'לא זמין';
    
    // Hebrew dates
    const hebrewDeathDateElement = document.getElementById('hebrewDeathDate');
    if (memorial.death_date_hebrew) {
        hebrewDeathDateElement.textContent = memorial.death_date_hebrew;
    }
    
    // Next yahrzeit
    const nextYahrzeitElement = document.getElementById('nextYahrzeit');
    if (memorial.next_yahrzeit_gregorian) {
        const nextYahrzeit = new Date(memorial.next_yahrzeit_gregorian);
        const today = new Date();
        const daysUntil = Math.ceil((nextYahrzeit - today) / (1000 * 60 * 60 * 24));
        nextYahrzeitElement.textContent = 
            `${formatHebrewDate(memorial.next_yahrzeit_gregorian)} (בעוד ${daysUntil} ימים)`;
    } else {
        nextYahrzeitElement.textContent = 'לא חושב';
    }
    
    // Memorial media
    if (memorial.memorial_song_url) {
        const mediaDiv = document.getElementById('memorialMedia');
        const iframe = document.getElementById('memorialVideo');
        
        if (memorial.memorial_song_url.includes('youtube.com') || memorial.memorial_song_url.includes('youtu.be')) {
            const videoId = extractYouTubeId(memorial.memorial_song_url);
            if (videoId) {
                iframe.src = `https://www.youtube.com/embed/${videoId}`;
                mediaDiv.classList.remove('d-none');
            }
        }
    }
    
    // Photos
    displayPhotos(memorial.photos || []);
    
    // Set profile photo if available
    if (memorial.photos && memorial.photos.length > 0) {
        const profilePhoto = memorial.photos.find(p => p.is_primary) || memorial.photos[0];
        if (profilePhoto) {
            const memorialPhotoElement = document.getElementById('memorialPhoto');
            if (memorialPhotoElement) {
                memorialPhotoElement.src = profilePhoto.file_url || profilePhoto.file_path;
            }
        }
    }
    
    // Show memorial
    loadingSpinner.classList.add('d-none');
    memorialTemplate.classList.remove('d-none');
    
    // Update page views (silent)
    updatePageViews(memorial.unique_slug);
}

// CRITICAL: Load Hebrew verses when verses tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const versesTab = document.getElementById('verses-tab');
    if (versesTab) {
        versesTab.addEventListener('shown.bs.tab', function() {
            if (currentMemorial && currentMemorial.deceased_name_hebrew) {
                loadMemorialVerses();
            }
        });
    }
});

async function loadMemorialVerses() {
    if (!currentMemorial || !currentMemorial.deceased_name_hebrew) {
        return;
    }
    
    const versesLoading = document.getElementById('versesLoading');
    const versesContent = document.getElementById('versesContent');
    const versesError = document.getElementById('versesError');
    const nameVersesContainer = document.getElementById('nameVersesContainer');
    const neshamaVersesContainer = document.getElementById('neshamaVersesContainer');
    
    // Show loading
    versesLoading.classList.remove('d-none');
    versesContent.classList.add('d-none');
    versesError.classList.add('d-none');
    
    try {
        console.log('Loading verses for Hebrew name:', currentMemorial.deceased_name_hebrew);
        
        // Call the memorial verse engine API
        const response = await fetch(`/api/v1/hebrew/memorial-verses?name=${encodeURIComponent(currentMemorial.deceased_name_hebrew)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const versesData = await response.json();
        console.log('Verses loaded:', versesData);
        
        // Separate sections into name sections and neshama sections
        const nameSections = versesData.sections ? versesData.sections.filter(s => !s.is_neshama) : [];
        const neshamaSections = versesData.sections ? versesData.sections.filter(s => s.is_neshama) : [];
        
        // Display name verses
        if (nameSections.length > 0) {
            let nameVersesHtml = '';
            
            nameSections.forEach(section => {
                nameVersesHtml += createVerseSectionHtml(section, false);
            });
            
            nameVersesContainer.innerHTML = nameVersesHtml;
        } else {
            nameVersesContainer.innerHTML = '<p class="text-center text-muted hebrew-text">לא נמצאו פסוקים לאותיות השם</p>';
        }
        
        // Display neshama verses
        if (neshamaSections.length > 0) {
            let neshamaVersesHtml = '';
            
            neshamaSections.forEach(section => {
                neshamaVersesHtml += createVerseSectionHtml(section, true);
            });
            
            neshamaVersesContainer.innerHTML = neshamaVersesHtml;
        } else {
            neshamaVersesContainer.innerHTML = '<p class="text-center text-muted hebrew-text">לא נמצאו פסוקי נשמה</p>';
        }
        
        // Show content
        versesLoading.classList.add('d-none');
        versesContent.classList.remove('d-none');
        
    } catch (error) {
        console.error('Error loading verses:', error);
        
        // Show error
        versesLoading.classList.add('d-none');
        versesError.classList.remove('d-none');
    }
}

function createVerseSectionHtml(section, isNeshama = false) {
    const headerClass = isNeshama ? 'neshama-verse-section-header' : 'verse-section-header';
    
    let versesHtml = '';
    if (section.verses && section.verses.length > 0) {
        section.verses.forEach(verse => {
            versesHtml += `
                <div class="verse-container">
                    <div class="verse-number">תהילים קיט:${verse.verse_number}</div>
                    <div class="verse-hebrew">${verse.hebrew_text}</div>
                    ${verse.transliteration ? `<div class="verse-transliteration">${verse.transliteration}</div>` : ''}
                    ${verse.english_text ? `<div class="verse-english">${verse.english_text}</div>` : ''}
                </div>
            `;
        });
    }
    
    return `
        <div class="verse-section">
            <div class="${headerClass}">
                <div class="verse-letter-title">${section.letter.hebrew_letter}</div>
                <div class="verse-letter-name">${section.letter.hebrew_name}</div>
                <div class="small">${section.verses ? section.verses.length : 0} פסוקים</div>
            </div>
            ${versesHtml}
        </div>
    `;
}

function displayPhotos(photos) {
    const gallery = document.getElementById('photoGallery');
    const noPhotos = document.getElementById('noPhotos');
    
    if (!photos || photos.length === 0) {
        noPhotos.classList.remove('d-none');
        return;
    }
    
    gallery.innerHTML = photos.map(photo => `
        <div class="col-md-4 col-sm-6">
            <div class="card">
                <img src="${photo.file_url || photo.file_path}" alt="${photo.caption || 'תמונת הנצחה'}" 
                     class="card-img-top" style="height: 200px; object-fit: cover;"
                     onclick="showPhotoModal('${photo.file_url || photo.file_path}', '${photo.caption || ''}')">
                ${photo.caption ? `<div class="card-body"><p class="card-text small hebrew-text">${photo.caption}</p></div>` : ''}
            </div>
        </div>
    `).join('');
}

function extractYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function formatHebrewDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('he-IL');
}

function shareMemorial() {
    const title = currentMemorial ? 
        (currentMemorial.deceased_name_hebrew || currentMemorial.deceased_name_english || 'הנצחה') :
        'הנצחה';
    const url = window.location.href;
    
    if (navigator.share) {
        navigator.share({
            title: `הנצחה עבור ${title}`,
            text: 'צפה בדף הנצחה זה',
            url: url
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            if (typeof HebrewMemorialApp !== 'undefined') {
                HebrewMemorialApp.showSuccess('הקישור הועתק ללוח');
            } else {
                alert('הקישור הועתק ללוח');
            }
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('הקישור הועתק ללוח');
        });
    }
}

function showPhotoModal(imageSrc, caption) {
    // Create a simple modal for photo viewing
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hebrew-text">${caption || 'תמונה'}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="${imageSrc}" class="img-fluid" alt="${caption || 'תמונה'}">
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

async function updatePageViews(slug) {
    try {
        // In a real implementation, you'd call an endpoint to update views
        // For now, this is just a placeholder
        console.log('Page view recorded for:', slug);
    } catch (error) {
        // Silent fail for page view tracking
        console.log('Failed to update page views:', error);
    }
}
</script>
{% endblock %}