{% extends "base_rtl.html" %}

{% block title %}יצירת הנצחה חדשה - {% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-4">
                <i class="bi bi-heart-fill display-4 text-primary"></i>
                <h1 class="display-5 hebrew-title mt-2">יצירת הנצחה חדשה</h1>
                <p class="lead hebrew-text">צור דף הנצחה אישי עם פסוקי תהילים קיט</p>
            </div>
        </div>
    </div>

    <form id="memorialForm" class="hebrew-text">
        <!-- שלב 1: פרטי הנפטר -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0 hebrew-title">
                            <i class="bi bi-person-heart me-2"></i>פרטי הנפטר/ת
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Hebrew Names (Required) -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hebrew_first_name" class="form-label hebrew-text">
                                        <i class="bi bi-person-fill me-1"></i>שם פרטי בעברית *
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="hebrew_first_name" name="hebrew_first_name" 
                                           required placeholder="הזן שם פרטי" dir="rtl" tabindex="1">
                                    <div class="invalid-feedback hebrew-text" id="hebrew_first_name-error"></div>
                                </div>
                                
                                <!-- Full Hebrew Name - under first name -->
                                <div class="mb-3">
                                    <label for="deceased_name_hebrew" class="form-label hebrew-text">
                                        <i class="bi bi-star-of-david me-1"></i>שם מלא בעברית *
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="deceased_name_hebrew" name="deceased_name_hebrew" 
                                           required placeholder="הזן שם מלא כפי שהמשפחה קראה לו/לה" dir="rtl" tabindex="3">
                                    <div class="form-text hebrew-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        השם שבו קראה המשפחה לנפטר/ת בחייו/ה - ישמש לבחירת פסוקים מתהילים קיט
                                    </div>
                                    <div class="invalid-feedback hebrew-text" id="deceased_name_hebrew-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hebrew_last_name" class="form-label hebrew-text">
                                        <i class="bi bi-people-fill me-1"></i>שם משפחה בעברית *
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="hebrew_last_name" name="hebrew_last_name" 
                                           required placeholder="הזן שם משפחה" dir="rtl" tabindex="2">
                                    <div class="invalid-feedback hebrew-text" id="hebrew_last_name-error"></div>
                                </div>
                                
                                <!-- Parent Name - under last name -->
                                <div class="mb-3">
                                    <label for="parent_name_hebrew" class="form-label hebrew-text">
                                        <i class="bi bi-heart-fill me-1"></i>שם האם או שם האב של הנפטר/ת *
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="parent_name_hebrew" name="parent_name_hebrew" 
                                           required placeholder="הזן שם האם או האב" dir="rtl" tabindex="4">
                                    <div class="form-text hebrew-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        שם אחד ההורים של הנפטר/ת (אם או אב)
                                    </div>
                                    <div class="invalid-feedback hebrew-text" id="parent_name_hebrew-error"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- English Names (Optional) -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="english_first_name" class="form-label hebrew-text">
                                        שם פרטי באנגלית (אופציונלי)
                                    </label>
                                    <input type="text" class="form-control" 
                                           id="english_first_name" name="english_first_name" 
                                           placeholder="First name" dir="ltr" tabindex="5">
                                    <div class="invalid-feedback hebrew-text" id="english_first_name-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="english_last_name" class="form-label hebrew-text">
                                        שם משפחה באנגלית (אופציונלי)
                                    </label>
                                    <input type="text" class="form-control" 
                                           id="english_last_name" name="english_last_name" 
                                           placeholder="Last name" dir="ltr" tabindex="6">
                                    <div class="invalid-feedback hebrew-text" id="english_last_name-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="birth_date_gregorian" class="form-label hebrew-text">
                                        <i class="bi bi-calendar-heart me-1"></i>תאריך לידה (לועזי)
                                    </label>
                                    <input type="date" class="form-control" 
                                           id="birth_date_gregorian" name="birth_date_gregorian">
                                    <div class="invalid-feedback hebrew-text" id="birth_date_gregorian-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="birth_date_hebrew" class="form-label hebrew-text">
                                        תאריך לידה עברי (אופציונלי)
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="birth_date_hebrew" name="birth_date_hebrew" 
                                           placeholder="כ&quot;ח אדר תש&quot;נ" dir="rtl">
                                    <div class="invalid-feedback hebrew-text" id="birth_date_hebrew-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="death_date_gregorian" class="form-label hebrew-text">
                                        <i class="bi bi-calendar-x me-1"></i>תאריך פטירה (לועזי)
                                    </label>
                                    <input type="date" class="form-control" 
                                           id="death_date_gregorian" name="death_date_gregorian">
                                    <div class="invalid-feedback hebrew-text" id="death_date_gregorian-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="death_date_hebrew" class="form-label hebrew-text">
                                        תאריך פטירה עברי (אופציונלי)
                                    </label>
                                    <input type="text" class="form-control hebrew-input" 
                                           id="death_date_hebrew" name="death_date_hebrew" 
                                           placeholder="ה&quot; אלול תשפ&quot;ג" dir="rtl">
                                    <div class="invalid-feedback hebrew-text" id="death_date_hebrew-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="biography" class="form-label hebrew-text">
                                <i class="bi bi-journal-text me-1"></i>ביוגרפיה וזכרונות (אופציונלי)
                            </label>
                            <textarea class="form-control hebrew-input" id="biography" name="biography" 
                                      rows="6" placeholder="שתף זכרונות, סיפורים ואת מה שהיה מיוחד בו/בה..." 
                                      dir="rtl"></textarea>
                            <div class="form-text hebrew-text">
                                אפשר לכתב על התכונות, התחביבים, ההישגים וזכרונות יקרים
                            </div>
                            <div class="invalid-feedback hebrew-text" id="biography-error"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- שלב 2: הודעת פסוקים -->
        <div class="row justify-content-center" id="verse-info-section" style="display: none;">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4 border-info">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0 hebrew-title">
                            <i class="bi bi-book me-2"></i>פסוקי תהילים קיט
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <i class="bi bi-info-circle display-4 text-info mb-3"></i>
                            <h4 class="hebrew-title text-info">פסוקים יתווספו לאחר יצירת ההנצחה</h4>
                            <p class="lead hebrew-text">
                                הפסוקים המתאימים לשם העברי 
                                <strong class="text-primary" id="selected-name-display"></strong>
                                יופיעו בדף ההנצחה הסופי
                            </p>
                            <div class="alert alert-light border-info">
                                <p class="hebrew-text mb-0">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    הפסוקים יבחרו אוטומטית לפי האותיות בשם העברי ויכללו גם פסוקי נשמה
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- שלב 3: תמונות וסרטון -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0 hebrew-title">
                            <i class="bi bi-camera me-2"></i>תמונות וסרטון
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Photo Upload Section -->
                        <div class="mb-4">
                            <label class="form-label hebrew-text">
                                <i class="bi bi-images me-1"></i>תמונות (עד 4 תמונות)
                            </label>
                            <div class="row" id="photo-uploads">
                                <!-- Photo upload slots will be generated by JavaScript -->
                            </div>
                            <div class="form-text hebrew-text">
                                <i class="bi bi-info-circle me-1"></i>
                                ניתן להעלות עד 4 תמונות. גודל מקסימלי: 5MB לתמונה
                            </div>
                        </div>
                        
                        <!-- Video Upload Section -->
                        <div class="mb-3">
                            <label for="video_upload" class="form-label hebrew-text">
                                <i class="bi bi-camera-video me-1"></i>סרטון הנצחה (אחד)
                            </label>
                            <input type="file" class="form-control" 
                                   id="video_upload" name="video_upload" 
                                   accept="video/*">
                            <div class="form-text hebrew-text">
                                <i class="bi bi-info-circle me-1"></i>
                                גודל מקסימלי: 50MB. פורמטים נתמכים: MP4, AVI, MOV
                            </div>
                            <div class="invalid-feedback hebrew-text" id="video_upload-error"></div>
                        </div>
                        
                        <!-- Location Section -->
                        <div class="mb-4">
                            <label for="location" class="form-label hebrew-text">
                                <i class="bi bi-geo-alt me-1"></i>מיקום (אופציונלי)
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control hebrew-input" 
                                       id="location" name="location" 
                                       placeholder="הזן כתובת או שם מקום" dir="rtl">
                                <button type="button" class="btn btn-outline-primary" id="current-location-btn">
                                    <i class="bi bi-geo-alt-fill me-1"></i>המיקום שלי
                                </button>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-map me-1"></i>מפות
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item hebrew-text" href="#" id="open-google-maps">
                                            <i class="bi bi-google me-2"></i>גוגל מפות
                                        </a></li>
                                        <li><a class="dropdown-item hebrew-text" href="#" id="open-waze">
                                            <i class="bi bi-signpost-2 me-2"></i>Waze
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item hebrew-text" href="#" id="open-map-picker">
                                            <i class="bi bi-cursor me-2"></i>בחר במפה אינטראקטיבית
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <input type="hidden" id="location_lat" name="location_lat">
                            <input type="hidden" id="location_lng" name="location_lng">
                            <div class="form-text hebrew-text">
                                <i class="bi bi-info-circle me-1"></i>
                                מיקום קבורה, בית קברות או מקום זכרון. לחץ על "המיקום שלי" לזיהוי אוטומטי או "פתח במפות" לבחירה במפת גוגל
                            </div>
                            <div class="invalid-feedback hebrew-text" id="location-error"></div>
                            
                            <!-- Location Status Display -->
                            <div id="location-status" class="mt-2" style="display: none;">
                                <div class="alert alert-info alert-dismissible fade show hebrew-text" role="alert">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span id="location-status-text"></span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Contacts Section -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label hebrew-text">
                                        <i class="bi bi-whatsapp me-1"></i>מספרי WhatsApp לעדכונים (עד 5)
                                    </label>
                                    <div id="whatsapp-phones">
                                        <!-- WhatsApp inputs will be generated by JavaScript -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-success add-whatsapp hebrew-text">
                                        <i class="bi bi-plus me-1"></i>הוסף מספר
                                    </button>
                                    <div class="form-text hebrew-text">
                                        מספרי טלפון להודעות WhatsApp על אירועי זכרון
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label hebrew-text">
                                        <i class="bi bi-envelope me-1"></i>כתובות אימייל לעדכונים (עד 5)
                                    </label>
                                    <div id="notification-emails">
                                        <!-- Email inputs will be generated by JavaScript -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary add-email hebrew-text">
                                        <i class="bi bi-plus me-1"></i>הוסף אימייל
                                    </button>
                                    <div class="form-text hebrew-text">
                                        כתובות אימייל להודעות על אירועי זכרון
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- שלב 4: הגדרות נוספות -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0 hebrew-title">
                            <i class="bi bi-gear me-2"></i>הגדרות נוספות
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memorial_song_url" class="form-label hebrew-text">
                                        <i class="bi bi-music-note me-1"></i>קישור לשיר הנצחה (אופציונלי)
                                    </label>
                                    <input type="url" class="form-control" 
                                           id="memorial_song_url" name="memorial_song_url" 
                                           placeholder="https://..." dir="ltr">
                                    <div class="form-text hebrew-text">קישור לשיר או מלודיה המתאימים</div>
                                    <div class="invalid-feedback hebrew-text" id="memorial_song_url-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unique_slug" class="form-label hebrew-text">
                                        <i class="bi bi-link me-1"></i>כתובת אישית (אופציונלי)
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">/memorial/</span>
                                        <input type="text" class="form-control" 
                                               id="unique_slug" name="unique_slug" 
                                               placeholder="my-memorial" dir="ltr">
                                    </div>
                                    <div class="form-text hebrew-text">כתובת ייחודית לדף ההנצחה</div>
                                    <div class="invalid-feedback hebrew-text" id="unique_slug-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" 
                                           id="is_public" name="is_public" checked>
                                    <label class="form-check-label hebrew-text" for="is_public">
                                        <i class="bi bi-globe me-1"></i>הפוך לציבורי
                                    </label>
                                    <div class="form-text hebrew-text">
                                        אפשר לאחרים לראות ולחפש את ההנצחה
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" 
                                           id="enable_comments" name="enable_comments">
                                    <label class="form-check-label hebrew-text" for="enable_comments">
                                        <i class="bi bi-chat-heart me-1"></i>אפשר הודעות זכרון
                                    </label>
                                    <div class="form-text hebrew-text">
                                        אפשר לאנשים להשאיר הודעות זכרון
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- כפתורי פעולה -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-secondary hebrew-text" id="save-draft">
                        <i class="bi bi-file-earmark me-2"></i>שמור כטיוטה
                    </button>
                    <button type="submit" class="btn btn-success btn-lg hebrew-text">
                        <i class="bi bi-check-circle me-2"></i>צור הנצחה
                    </button>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Interactive Map Modal -->
    <div class="modal fade" id="mapPickerModal" tabindex="-1" aria-labelledby="mapPickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hebrew-title" id="mapPickerModalLabel">בחר מיקום במפה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="hebrew-text">לחץ על המפה כדי לבחור מיקום, או חפש כתובת:</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="map-search-input" placeholder="חפש כתובת או שם מקום" dir="rtl">
                            <button type="button" class="btn btn-outline-primary" id="map-search-btn">
                                <i class="bi bi-search me-1"></i>חפש
                            </button>
                        </div>
                    </div>
                    <div id="simple-map" style="height: 400px; border: 1px solid #ddd; border-radius: 0.375rem; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                        <div class="text-center hebrew-text">
                            <div class="mb-3">
                                <i class="bi bi-geo-alt display-1 text-muted"></i>
                            </div>
                            <h5>מפה אינטראקטיבית</h5>
                            <p class="text-muted">בגרסה זו ניתן להזין כתובת ידנית או להשתמש בכפתור "המיקום שלי"</p>
                            <p class="text-muted small">במימוש מלא תהיה כאן מפה אינטראקטיבית</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label hebrew-text">רוחב (Latitude):</label>
                                <input type="text" class="form-control" id="modal-lat" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label hebrew-text">אורך (Longitude):</label>
                                <input type="text" class="form-control" id="modal-lng" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hebrew-text" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary hebrew-text" id="select-location-btn">בחר מיקום זה</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const memorialForm = document.getElementById('memorialForm');
    const verseInfoSection = document.getElementById('verse-info-section');
    const selectedNameDisplay = document.getElementById('selected-name-display');
    
    // Photo upload management
    const photoUploads = document.getElementById('photo-uploads');
    const maxPhotos = 4;
    let photoFiles = [];
    
    // Initialize photo upload slots
    function initializePhotoUploads() {
        for (let i = 0; i < maxPhotos; i++) {
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-6 col-lg-3 mb-3';
            
            const uploadCard = `
                <div class="card h-100 photo-upload-card" data-index="${i}">
                    <div class="card-body d-flex flex-column align-items-center justify-content-center position-relative" style="min-height: 150px; border: 2px dashed #dee2e6;">
                        <input type="file" class="d-none photo-input" accept="image/*" data-index="${i}">
                        <div class="upload-area text-center">
                            <i class="bi bi-camera-fill display-4 text-muted mb-2"></i>
                            <p class="text-muted hebrew-text mb-2">תמונה ${i + 1}</p>
                            <button type="button" class="btn btn-outline-primary btn-sm upload-btn hebrew-text">
                                <i class="bi bi-upload me-1"></i>העלה תמונה
                            </button>
                        </div>
                        <div class="preview-area d-none">
                            <img class="preview-img" style="max-width: 100%; max-height: 120px; object-fit: cover;">
                            <div class="photo-actions mt-2 d-flex gap-1 justify-content-center">
                                <button type="button" class="btn btn-sm btn-outline-success set-primary hebrew-text" title="הגדר כתמונת פרופיל">
                                    <i class="bi bi-star me-1"></i>ראשית
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-photo hebrew-text">
                                    <i class="bi bi-trash me-1"></i>הסר
                                </button>
                            </div>
                            <div class="primary-indicator mt-1 d-none">
                                <small class="text-success hebrew-text">
                                    <i class="bi bi-star-fill me-1"></i>תמונת פרופיל
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            colDiv.innerHTML = uploadCard;
            photoUploads.appendChild(colDiv);
        }
    }
    
    // Handle photo upload interactions
    photoUploads.addEventListener('click', function(e) {
        if (e.target.closest('.upload-btn')) {
            const card = e.target.closest('.photo-upload-card');
            const index = card.dataset.index;
            const input = card.querySelector('.photo-input');
            input.click();
        }
        
        if (e.target.closest('.remove-photo')) {
            const card = e.target.closest('.photo-upload-card');
            const index = parseInt(card.dataset.index);
            removePhoto(index);
        }
        
        if (e.target.closest('.set-primary')) {
            const card = e.target.closest('.photo-upload-card');
            const index = parseInt(card.dataset.index);
            setPrimaryPhoto(index);
        }
    });
    
    // Handle file input changes
    photoUploads.addEventListener('change', function(e) {
        if (e.target.classList.contains('photo-input')) {
            const index = parseInt(e.target.dataset.index);
            const file = e.target.files[0];
            
            if (file) {
                if (validatePhotoFile(file)) {
                    addPhotoPreview(index, file);
                    photoFiles[index] = file;
                } else {
                    e.target.value = '';
                }
            }
        }
    });
    
    function validatePhotoFile(file) {
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        
        if (file.size > maxSize) {
            HebrewMemorialApp.showError('גודל התמונה חייב להיות קטן מ-5MB');
            return false;
        }
        
        if (!allowedTypes.includes(file.type)) {
            HebrewMemorialApp.showError('פורמט התמונה לא נתמך. השתמש ב-JPEG, PNG או WebP');
            return false;
        }
        
        return true;
    }
    
    function addPhotoPreview(index, file) {
        const card = document.querySelector(`[data-index="${index}"]`);
        const uploadArea = card.querySelector('.upload-area');
        const previewArea = card.querySelector('.preview-area');
        const previewImg = card.querySelector('.preview-img');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            uploadArea.classList.add('d-none');
            previewArea.classList.remove('d-none');
            card.querySelector('.card-body').style.border = '2px solid #198754';
        };
        reader.readAsDataURL(file);
    }
    
    function removePhoto(index) {
        const card = document.querySelector(`[data-index="${index}"]`);
        const uploadArea = card.querySelector('.upload-area');
        const previewArea = card.querySelector('.preview-area');
        const input = card.querySelector('.photo-input');
        
        photoFiles[index] = null;
        input.value = '';
        uploadArea.classList.remove('d-none');
        previewArea.classList.add('d-none');
        card.querySelector('.card-body').style.border = '2px dashed #dee2e6';
        
        // Remove primary status if this was the primary photo
        const primaryIndicator = card.querySelector('.primary-indicator');
        primaryIndicator.classList.add('d-none');
    }
    
    function setPrimaryPhoto(index) {
        // Remove primary status from all photos
        document.querySelectorAll('.primary-indicator').forEach(indicator => {
            indicator.classList.add('d-none');
        });
        document.querySelectorAll('.set-primary').forEach(btn => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
            btn.innerHTML = '<i class="bi bi-star me-1"></i>ראשית';
        });
        
        // Set this photo as primary
        const card = document.querySelector(`[data-index="${index}"]`);
        const primaryIndicator = card.querySelector('.primary-indicator');
        const setPrimaryBtn = card.querySelector('.set-primary');
        
        primaryIndicator.classList.remove('d-none');
        setPrimaryBtn.classList.remove('btn-outline-success');
        setPrimaryBtn.classList.add('btn-success');
        setPrimaryBtn.innerHTML = '<i class="bi bi-star-fill me-1"></i>ראשית';
        
        // Store which photo is primary
        window.primaryPhotoIndex = index;
        
        HebrewMemorialApp.showSuccess('תמונת הפרופיל הוגדרה בהצלחה');
    }
    
    // Video upload validation
    const videoInput = document.getElementById('video_upload');
    if (videoInput) {
        videoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 50 * 1024 * 1024; // 50MB
                const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime'];
                
                if (file.size > maxSize) {
                    HebrewMemorialApp.showError('גודל הסרטון חייב להיות קטן מ-50MB');
                    e.target.value = '';
                    return;
                }
                
                if (!allowedTypes.includes(file.type)) {
                    HebrewMemorialApp.showError('פורמט הסרטון לא נתמך. השתמש ב-MP4, AVI או MOV');
                    e.target.value = '';
                    return;
                }
                
                HebrewMemorialApp.showSuccess('הסרטון נבחר בהצלחה');
            }
        });
    }
    
    // Location functionality
    const locationInput = document.getElementById('location');
    const currentLocationBtn = document.getElementById('current-location-btn');
    const openMapsBtn = document.getElementById('open-maps-btn');
    const locationLat = document.getElementById('location_lat');
    const locationLng = document.getElementById('location_lng');
    const locationStatus = document.getElementById('location-status');
    const locationStatusText = document.getElementById('location-status-text');
    
    // Get current user location
    if (currentLocationBtn) {
        currentLocationBtn.addEventListener('click', async function() {
            if (!navigator.geolocation) {
                HebrewMemorialApp.showError('הדפדפן שלך לא תומך בזיהוי מיקום');
                return;
            }
            
            // Show loading state
            const originalContent = currentLocationBtn.innerHTML;
            currentLocationBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>מזהה מיקום...';
            currentLocationBtn.disabled = true;
            
            try {
                const position = await getCurrentPosition();
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Store coordinates
                locationLat.value = lat.toString();
                locationLng.value = lng.toString();
                
                // Get address from coordinates using reverse geocoding
                const address = await reverseGeocode(lat, lng);
                if (address) {
                    locationInput.value = address;
                    showLocationStatus(`מיקום זוהה: ${address}`, 'success');
                } else {
                    locationInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    showLocationStatus('מיקום זוהה (קואורדינטות)', 'success');
                }
                
                HebrewMemorialApp.showSuccess('המיקום זוהה בהצלחה!');
                
            } catch (error) {
                console.error('Geolocation error:', error);
                let errorMessage = 'לא ניתן לזהות את המיקום';
                
                if (error.code === 1) {
                    errorMessage = 'אנא אפשר גישה למיקום בהגדרות הדפדפן';
                } else if (error.code === 2) {
                    errorMessage = 'המיקום לא זמין כרגע';
                } else if (error.code === 3) {
                    errorMessage = 'זיהוי המיקום לקח יותר מדי זמן';
                }
                
                HebrewMemorialApp.showError(errorMessage);
                showLocationStatus(errorMessage, 'error');
            } finally {
                // Restore button state
                currentLocationBtn.innerHTML = originalContent;
                currentLocationBtn.disabled = false;
            }
        });
    }
    
    // Map dropdown options
    const openGoogleMapsBtn = document.getElementById('open-google-maps');
    const openWazeBtn = document.getElementById('open-waze');
    const openMapPickerBtn = document.getElementById('open-map-picker');
    const mapPickerModal = new bootstrap.Modal(document.getElementById('mapPickerModal'));
    
    // Open in Google Maps
    if (openGoogleMapsBtn) {
        openGoogleMapsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const lat = locationLat.value;
            const lng = locationLng.value;
            const address = locationInput.value.trim();
            
            let mapsUrl;
            
            if (lat && lng) {
                // If we have coordinates, use them for precise location
                mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            } else if (address) {
                // If we have an address, search for it
                mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            } else {
                // Open general Google Maps
                mapsUrl = 'https://www.google.com/maps';
            }
            
            // Open in new window/tab
            window.open(mapsUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            
            showLocationStatus('מפת גוגל נפתחה בחלון חדש', 'info');
        });
    }
    
    // Open in Waze
    if (openWazeBtn) {
        openWazeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const lat = locationLat.value;
            const lng = locationLng.value;
            const address = locationInput.value.trim();
            
            let wazeUrl;
            
            if (lat && lng) {
                // Waze with coordinates
                wazeUrl = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
            } else if (address) {
                // Waze with address search
                wazeUrl = `https://waze.com/ul?q=${encodeURIComponent(address)}`;
            } else {
                // Open general Waze
                wazeUrl = 'https://waze.com';
            }
            
            // Open in new window/tab
            window.open(wazeUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            
            showLocationStatus('Waze נפתח בחלון חדש', 'info');
        });
    }
    
    // Open interactive map picker
    if (openMapPickerBtn) {
        openMapPickerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Pre-fill modal with current values
            const modalSearchInput = document.getElementById('map-search-input');
            const modalLat = document.getElementById('modal-lat');
            const modalLng = document.getElementById('modal-lng');
            
            modalSearchInput.value = locationInput.value;
            modalLat.value = locationLat.value;
            modalLng.value = locationLng.value;
            
            mapPickerModal.show();
        });
    }
    
    // Modal map search functionality
    const mapSearchBtn = document.getElementById('map-search-btn');
    const mapSearchInput = document.getElementById('map-search-input');
    const selectLocationBtn = document.getElementById('select-location-btn');
    
    if (mapSearchBtn) {
        mapSearchBtn.addEventListener('click', async function() {
            const searchQuery = mapSearchInput.value.trim();
            if (!searchQuery) {
                HebrewMemorialApp.showError('אנא הזן כתובת לחיפוש');
                return;
            }
            
            // Show loading
            const originalContent = mapSearchBtn.innerHTML;
            mapSearchBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>מחפש...';
            mapSearchBtn.disabled = true;
            
            try {
                const coordinates = await geocodeAddress(searchQuery);
                if (coordinates) {
                    const modalLat = document.getElementById('modal-lat');
                    const modalLng = document.getElementById('modal-lng');
                    
                    modalLat.value = coordinates.lat.toString();
                    modalLng.value = coordinates.lng.toString();
                    
                    HebrewMemorialApp.showSuccess(`נמצא מיקום: ${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`);
                } else {
                    HebrewMemorialApp.showError('לא נמצא מיקום עבור הכתובת');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                HebrewMemorialApp.showError('שגיאה בחיפוש המיקום');
            } finally {
                // Restore button
                mapSearchBtn.innerHTML = originalContent;
                mapSearchBtn.disabled = false;
            }
        });
    }
    
    // Select location from modal
    if (selectLocationBtn) {
        selectLocationBtn.addEventListener('click', function() {
            const modalLat = document.getElementById('modal-lat');
            const modalLng = document.getElementById('modal-lng');
            const modalSearchInput = document.getElementById('map-search-input');
            
            // Copy values to main form
            locationLat.value = modalLat.value;
            locationLng.value = modalLng.value;
            locationInput.value = modalSearchInput.value;
            
            // Close modal
            mapPickerModal.hide();
            
            showLocationStatus('מיקום נבחר בהצלחה', 'success');
            HebrewMemorialApp.showSuccess('מיקום נבחר ונשמר בטופס');
        });
    }
    
    // Helper function to get current position as Promise
    function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            const options = {
                enableHighAccuracy: true,
                timeout: 10000, // 10 seconds
                maximumAge: 300000 // 5 minutes
            };
            
            navigator.geolocation.getCurrentPosition(resolve, reject, options);
        });
    }
    
    // Helper function for forward geocoding (address to coordinates)
    async function geocodeAddress(address) {
        try {
            // Using OpenStreetMap Nominatim API for geocoding
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Geocoding request failed');
            }
            
            const data = await response.json();
            
            if (data && data.length > 0) {
                const result = data[0];
                return {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon),
                    display_name: result.display_name
                };
            }
            
            return null;
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
    }
    
    // Helper function for reverse geocoding
    async function reverseGeocode(lat, lng) {
        try {
            // Using OpenStreetMap Nominatim API for reverse geocoding (free, no API key needed)
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Geocoding request failed');
            }
            
            const data = await response.json();
            
            if (data && data.display_name) {
                // Extract meaningful address parts
                const address = data.address;
                let formattedAddress = '';
                
                if (address) {
                    const parts = [];
                    if (address.house_number && address.road) {
                        parts.push(`${address.road} ${address.house_number}`);
                    } else if (address.road) {
                        parts.push(address.road);
                    }
                    
                    if (address.city || address.town || address.village) {
                        parts.push(address.city || address.town || address.village);
                    }
                    
                    if (address.country) {
                        parts.push(address.country);
                    }
                    
                    formattedAddress = parts.join(', ');
                }
                
                return formattedAddress || data.display_name;
            }
            
            return null;
        } catch (error) {
            console.error('Reverse geocoding error:', error);
            return null;
        }
    }
    
    // Show location status message
    function showLocationStatus(message, type) {
        locationStatusText.textContent = message;
        locationStatus.style.display = 'block';
        
        const alertDiv = locationStatus.querySelector('.alert');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show hebrew-text`;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            alert.close();
        }, 5000);
    }
    
    // Optional: Auto-detect location on page load (with user permission)
    // Uncomment the following if you want to auto-detect location when the page loads
    /*
    window.addEventListener('load', function() {
        if (navigator.geolocation && !locationInput.value.trim()) {
            // Only auto-detect if location field is empty
            currentLocationBtn.click();
        }
    });
    */
    
    // Initialize photo uploads
    initializePhotoUploads();
    
    // Contact management
    const whatsappContainer = document.getElementById('whatsapp-phones');
    const emailContainer = document.getElementById('notification-emails');
    const addWhatsAppBtn = document.querySelector('.add-whatsapp');
    const addEmailBtn = document.querySelector('.add-email');
    let whatsappCount = 0;
    let emailCount = 0;
    
    // Initialize with one empty field for each
    addWhatsAppField();
    addEmailField();
    
    function addWhatsAppField() {
        if (whatsappCount >= 5) {
            HebrewMemorialApp.showError('ניתן להוסיף עד 5 מספרי WhatsApp');
            return;
        }
        
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'input-group mb-2 whatsapp-field';
        fieldDiv.innerHTML = `
            <span class="input-group-text"><i class="bi bi-whatsapp"></i></span>
            <input type="tel" class="form-control" name="whatsapp_phone_${whatsappCount}" 
                   placeholder="+972-50-1234567" dir="ltr">
            <button type="button" class="btn btn-outline-danger remove-whatsapp">
                <i class="bi bi-trash"></i>
            </button>
        `;
        whatsappContainer.appendChild(fieldDiv);
        whatsappCount++;
        
        updateWhatsAppButton();
    }
    
    function removeWhatsAppField(field) {
        field.remove();
        whatsappCount--;
        updateWhatsAppButton();
    }
    
    function updateWhatsAppButton() {
        if (whatsappCount >= 5) {
            addWhatsAppBtn.style.display = 'none';
        } else {
            addWhatsAppBtn.style.display = 'inline-block';
        }
    }
    
    function addEmailField() {
        if (emailCount >= 5) {
            HebrewMemorialApp.showError('ניתן להוסיף עד 5 כתובות אימייל');
            return;
        }
        
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'input-group mb-2 email-field';
        fieldDiv.innerHTML = `
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" class="form-control" name="notification_email_${emailCount}" 
                   placeholder="example@email.com" dir="ltr">
            <button type="button" class="btn btn-outline-danger remove-email">
                <i class="bi bi-trash"></i>
            </button>
        `;
        emailContainer.appendChild(fieldDiv);
        emailCount++;
        
        updateEmailButton();
    }
    
    function removeEmailField(field) {
        field.remove();
        emailCount--;
        updateEmailButton();
    }
    
    function updateEmailButton() {
        if (emailCount >= 5) {
            addEmailBtn.style.display = 'none';
        } else {
            addEmailBtn.style.display = 'inline-block';
        }
    }
    
    // Event listeners for contact fields
    if (addWhatsAppBtn) {
        addWhatsAppBtn.addEventListener('click', addWhatsAppField);
    }
    
    if (addEmailBtn) {
        addEmailBtn.addEventListener('click', addEmailField);
    }
    
    // Event delegation for remove buttons
    whatsappContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-whatsapp')) {
            const field = e.target.closest('.whatsapp-field');
            removeWhatsAppField(field);
        }
    });
    
    emailContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-email')) {
            const field = e.target.closest('.email-field');
            removeEmailField(field);
        }
    });

    // Hebrew name validation and verse loading
    const hebrewFirstNameInput = document.getElementById('hebrew_first_name');
    const hebrewLastNameInput = document.getElementById('hebrew_last_name');
    const deceasedNameHebrewInput = document.getElementById('deceased_name_hebrew');
    
    function updateVerseInfo() {
        const deceasedNameHebrew = deceasedNameHebrewInput.value.trim();
        
        if (!deceasedNameHebrew) {
            verseInfoSection.style.display = 'none';
            return;
        }
        
        // Validate the full Hebrew name
        const nameValidation = HebrewMemorialApp.validateHebrewName(deceasedNameHebrew);
        
        if (!nameValidation.valid) {
            verseInfoSection.style.display = 'none';
            return;
        }
        
        // Show verse info with full name
        selectedNameDisplay.textContent = deceasedNameHebrew;
        verseInfoSection.style.display = 'block';
        // Remove auto-scrolling - no scrollIntoView
    }
    
    if (deceasedNameHebrewInput) {
        deceasedNameHebrewInput.addEventListener('blur', updateVerseInfo);
    }


    // Client-side form validation
    function validateForm() {
        let isValid = true;
        const errors = [];
        
        // Clear previous errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        
        // Validate Hebrew first name (required)
        const hebrewFirstName = document.getElementById('hebrew_first_name').value.trim();
        if (!hebrewFirstName) {
            isValid = false;
            errors.push('שם פרטי בעברית הוא שדה חובה');
            document.getElementById('hebrew_first_name').classList.add('is-invalid');
            document.getElementById('hebrew_first_name-error').textContent = 'שדה חובה';
        } else {
            const validation = HebrewMemorialApp.validateHebrewName(hebrewFirstName);
            if (!validation.valid) {
                isValid = false;
                errors.push(validation.message);
                document.getElementById('hebrew_first_name').classList.add('is-invalid');
                document.getElementById('hebrew_first_name-error').textContent = validation.message;
            }
        }
        
        // Validate Hebrew last name (required)
        const hebrewLastName = document.getElementById('hebrew_last_name').value.trim();
        if (!hebrewLastName) {
            isValid = false;
            errors.push('שם משפחה בעברית הוא שדה חובה');
            document.getElementById('hebrew_last_name').classList.add('is-invalid');
            document.getElementById('hebrew_last_name-error').textContent = 'שדה חובה';
        } else {
            const validation = HebrewMemorialApp.validateHebrewName(hebrewLastName);
            if (!validation.valid) {
                isValid = false;
                errors.push(validation.message);
                document.getElementById('hebrew_last_name').classList.add('is-invalid');
                document.getElementById('hebrew_last_name-error').textContent = validation.message;
            }
        }
        
        // Validate full Hebrew name (required)
        const deceasedNameHebrew = document.getElementById('deceased_name_hebrew').value.trim();
        if (!deceasedNameHebrew) {
            isValid = false;
            errors.push('שם מלא בעברית הוא שדה חובה');
            document.getElementById('deceased_name_hebrew').classList.add('is-invalid');
            document.getElementById('deceased_name_hebrew-error').textContent = 'שדה חובה';
        } else {
            const validation = HebrewMemorialApp.validateHebrewName(deceasedNameHebrew);
            if (!validation.valid) {
                isValid = false;
                errors.push(validation.message);
                document.getElementById('deceased_name_hebrew').classList.add('is-invalid');
                document.getElementById('deceased_name_hebrew-error').textContent = validation.message;
            }
        }
        
        // Validate parent name (required)
        const parentNameHebrew = document.getElementById('parent_name_hebrew').value.trim();
        if (!parentNameHebrew) {
            isValid = false;
            errors.push('שם האם או שם האב הוא שדה חובה');
            document.getElementById('parent_name_hebrew').classList.add('is-invalid');
            document.getElementById('parent_name_hebrew-error').textContent = 'שדה חובה';
        } else {
            const validation = HebrewMemorialApp.validateHebrewName(parentNameHebrew);
            if (!validation.valid) {
                isValid = false;
                errors.push(validation.message);
                document.getElementById('parent_name_hebrew').classList.add('is-invalid');
                document.getElementById('parent_name_hebrew-error').textContent = validation.message;
            }
        }
        
        // Validate memorial song URL if provided
        const songUrl = document.getElementById('memorial_song_url').value.trim();
        if (songUrl) {
            try {
                new URL(songUrl);
            } catch {
                isValid = false;
                errors.push('כתובת השיר אינה תקינה');
                document.getElementById('memorial_song_url').classList.add('is-invalid');
                document.getElementById('memorial_song_url-error').textContent = 'יש להזין כתובת אינטרנט תקינה';
            }
        }
        
        // Validate unique slug if provided
        const uniqueSlug = document.getElementById('unique_slug').value.trim();
        if (uniqueSlug) {
            const slugPattern = /^[a-z0-9-]+$/;
            if (!slugPattern.test(uniqueSlug)) {
                isValid = false;
                errors.push('כתובת אישית יכולה להכיל רק אותיות אנגליות קטנות, מספרים ומקפים');
                document.getElementById('unique_slug').classList.add('is-invalid');
                document.getElementById('unique_slug-error').textContent = 'רק אותיות אנגליות קטנות, מספרים ומקפים';
            }
        }
        
        return { isValid, errors };
    }

    // Form submission
    memorialForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = memorialForm.querySelector('button[type="submit"]');
        
        // Validate form before submission
        const validation = validateForm();
        if (!validation.isValid) {
            validation.errors.forEach(error => {
                HebrewMemorialApp.showError(error);
            });
            return;
        }
        
        HebrewMemorialApp.showLoading(submitBtn, 'יוצר הנצחה...');
        
        // Get form values directly from elements (more reliable)
        const hebrewFirstName = document.getElementById('hebrew_first_name').value.trim();
        const hebrewLastName = document.getElementById('hebrew_last_name').value.trim();
        const deceasedNameHebrew = document.getElementById('deceased_name_hebrew').value.trim();
        const parentNameHebrew = document.getElementById('parent_name_hebrew').value.trim();
        const englishFirstName = document.getElementById('english_first_name').value.trim();
        const englishLastName = document.getElementById('english_last_name').value.trim();
        
        // Debug: Log the form data values
        console.log('Form data values:', {
            hebrewFirstName,
            hebrewLastName,
            deceasedNameHebrew,
            parentNameHebrew,
            englishFirstName,
            englishLastName
        });
        
        // Validate required fields have values
        if (!hebrewFirstName || !hebrewLastName || !deceasedNameHebrew || !parentNameHebrew) {
            console.error('Missing required Hebrew names:', { hebrewFirstName, hebrewLastName, deceasedNameHebrew, parentNameHebrew });
            HebrewMemorialApp.showError('שגיאה: שדות חובה חסרים. אנא בדוק את השדות.');
            HebrewMemorialApp.hideLoading(submitBtn, 'צור הנצחה');
            return;
        }
        
        // Create FormData for multipart upload (handles files and text)
        const submitFormData = new FormData();
        
        // Add text fields - ensure required fields are always sent
        submitFormData.append('hebrew_first_name', hebrewFirstName);
        submitFormData.append('hebrew_last_name', hebrewLastName);
        submitFormData.append('deceased_name_hebrew', deceasedNameHebrew);
        submitFormData.append('parent_name_hebrew', parentNameHebrew);
        
        if (englishFirstName) submitFormData.append('english_first_name', englishFirstName);
        if (englishLastName) submitFormData.append('english_last_name', englishLastName);
        if (englishFirstName && englishLastName) {
            submitFormData.append('deceased_name_english', `${englishFirstName} ${englishLastName}`.trim());
        } else if (englishFirstName || englishLastName) {
            submitFormData.append('deceased_name_english', englishFirstName || englishLastName);
        }
        
        // Get other form values directly from elements
        const birthDate = document.getElementById('birth_date_gregorian').value.trim();
        const birthDateHebrew = document.getElementById('birth_date_hebrew').value.trim();
        const deathDate = document.getElementById('death_date_gregorian').value.trim();
        const deathDateHebrew = document.getElementById('death_date_hebrew').value.trim();
        const biography = document.getElementById('biography').value.trim();
        const songUrl = document.getElementById('memorial_song_url').value.trim();
        const uniqueSlug = document.getElementById('unique_slug').value.trim();
        const location = document.getElementById('location').value.trim();
        const locationLat = document.getElementById('location_lat').value.trim();
        const locationLng = document.getElementById('location_lng').value.trim();
        
        if (birthDate) submitFormData.append('birth_date_gregorian', birthDate);
        if (birthDateHebrew) submitFormData.append('birth_date_hebrew', birthDateHebrew);
        if (deathDate) submitFormData.append('death_date_gregorian', deathDate);
        if (deathDateHebrew) submitFormData.append('death_date_hebrew', deathDateHebrew);
        if (biography) submitFormData.append('biography', biography);
        if (songUrl) submitFormData.append('memorial_song_url', songUrl);
        if (uniqueSlug) submitFormData.append('unique_slug', uniqueSlug);
        if (location) submitFormData.append('location', location);
        if (locationLat) submitFormData.append('location_lat', locationLat);
        if (locationLng) submitFormData.append('location_lng', locationLng);
        
        // Get checkbox values directly
        const isPublic = document.getElementById('is_public').checked;
        const enableComments = document.getElementById('enable_comments').checked;
        
        submitFormData.append('is_public', isPublic.toString());
        submitFormData.append('enable_comments', enableComments.toString());
        
        // Add photos
        photoFiles.forEach((file, index) => {
            if (file) {
                submitFormData.append(`photo_${index}`, file);
                // Mark if this is the primary photo
                if (window.primaryPhotoIndex === index) {
                    submitFormData.append(`photo_${index}_is_primary`, 'true');
                }
            }
        });
        
        // If no primary photo was explicitly set, make the first photo primary
        if (window.primaryPhotoIndex === undefined) {
            const firstPhotoIndex = photoFiles.findIndex(file => file !== null);
            if (firstPhotoIndex !== -1) {
                submitFormData.append(`photo_${firstPhotoIndex}_is_primary`, 'true');
            }
        }
        
        // Add video
        const videoFile = document.getElementById('video_upload').files[0];
        if (videoFile) {
            submitFormData.append('video', videoFile);
        }
        
        // Add contact data
        const whatsappPhones = [];
        const notificationEmails = [];
        
        // Collect WhatsApp numbers
        document.querySelectorAll('[name^="whatsapp_phone_"]').forEach(input => {
            if (input.value.trim()) {
                whatsappPhones.push(input.value.trim());
            }
        });
        
        // Collect notification emails
        document.querySelectorAll('[name^="notification_email_"]').forEach(input => {
            if (input.value.trim()) {
                notificationEmails.push(input.value.trim());
            }
        });
        
        if (whatsappPhones.length > 0) {
            submitFormData.append('whatsapp_phones', JSON.stringify(whatsappPhones));
        }
        
        if (notificationEmails.length > 0) {
            submitFormData.append('notification_emails', JSON.stringify(notificationEmails));
        }
        
        // Debug: Log the final FormData contents
        console.log('Final FormData contents:');
        for (let [key, value] of submitFormData.entries()) {
            console.log(`${key}:`, value);
        }
        
        try {
            const response = await HebrewMemorialApp.apiCall('/memorials/with-files', {
                method: 'POST',
                body: submitFormData,
                headers: {} // Let browser set Content-Type for FormData
            });
            
            HebrewMemorialApp.showSuccess('ההנצחה נוצרה בהצלחה!');
            
            // Redirect to the new memorial page
            setTimeout(() => {
                const memorialUrl = response.public_url || `/he/memorials/${response.id}`;
                window.location.href = memorialUrl;
            }, 1500);
            
        } catch (error) {
            console.error('Error creating memorial:', error);
            
            if (error instanceof ValidationError) {
                // Handle validation errors with Hebrew field-specific messages
                HebrewMemorialApp.handleValidationErrors(error.validationData.detail || []);
            } else if (error.response && error.response.status === 422) {
                // Handle 422 validation errors from server
                try {
                    const errorData = await error.response.json();
                    console.error('422 Validation Error Details:', errorData);
                    
                    if (errorData.detail && Array.isArray(errorData.detail)) {
                        errorData.detail.forEach(err => {
                            const fieldName = err.loc && err.loc.length > 1 ? err.loc[1] : 'שדה לא ידוע';
                            let hebrewFieldName = fieldName;
                            
                            // Translate field names to Hebrew
                            const fieldTranslations = {
                                'hebrew_first_name': 'שם פרטי בעברית',
                                'hebrew_last_name': 'שם משפחה בעברית', 
                                'deceased_name_hebrew': 'שם מלא בעברית',
                                'birth_date_gregorian': 'תאריך לידה',
                                'death_date_gregorian': 'תאריך פטירה'
                            };
                            
                            if (fieldTranslations[fieldName]) {
                                hebrewFieldName = fieldTranslations[fieldName];
                            }
                            
                            HebrewMemorialApp.showError(`${hebrewFieldName}: ${err.msg}`);
                        });
                    } else if (errorData.detail) {
                        HebrewMemorialApp.showError('שגיאת תיקוף: ' + errorData.detail);
                    } else {
                        HebrewMemorialApp.showError('נתונים לא תקינים. אנא בדוק את הפרטים שהזנת.');
                    }
                } catch (parseError) {
                    console.error('Error parsing validation response:', parseError);
                    HebrewMemorialApp.showError('נתונים לא תקינים. אנא בדוק את הפרטים שהזנת.');
                }
            } else if (error.message.includes('403')) {
                // Handle memorial limit errors with the specific Hebrew message from the API
                try {
                    const errorData = await error.response.json();
                    if (errorData.detail && typeof errorData.detail === 'string') {
                        HebrewMemorialApp.showError(errorData.detail);
                    } else if (errorData.detail && errorData.detail.includes('לא מאומת')) {
                        HebrewMemorialApp.showError('החשבון שלך טרם אומת. אנא בדוק את האימייל שלך ולחץ על קישור האימות.');
                    } else if (errorData.error && errorData.error.includes('Rate limit exceeded')) {
                        HebrewMemorialApp.showError('חרגת ממגבלת יצירת האזכרות (10 לשעה). אנא נסה שוב מאוחר יותר.');
                    } else {
                        HebrewMemorialApp.showError('הגעת למגבלת האזכרות המותרות. שדרג את החשבון שלך.');
                    }
                } catch (parseError) {
                    console.error('Error parsing 403 response:', parseError);
                    HebrewMemorialApp.showError('הגעת למגבלת האזכרות המותרות. שדרג את החשבון שלך.');
                }
            } else if (error.message.includes('409')) {
                HebrewMemorialApp.showError('כתובת אישית כבר קיימת. אנא בחר כתובת אחרת.');
            } else if (error.message.includes('422')) {
                HebrewMemorialApp.showError('נתונים לא תקינים. אנא בדוק את הפרטים שהזנת.');
            } else if (error.message.includes('429')) {
                // Handle rate limit errors (Too Many Requests)
                HebrewMemorialApp.showError('חרגת ממגבלת יצירת האזכרות (10 לשעה). אנא נסה שוב מאוחר יותר.');
            } else {
                HebrewMemorialApp.showError('שגיאה ביצירת ההנצחה. אנא נסה שנית.');
            }
        } finally {
            HebrewMemorialApp.hideLoading(submitBtn);
        }
    });

    // Save draft functionality
    const saveDraftBtn = document.getElementById('save-draft');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function() {
            // Save form data to localStorage
            const formData = new FormData(memorialForm);
            const draftData = {};
            
            for (let [key, value] of formData.entries()) {
                draftData[key] = value;
            }
            
            draftData.timestamp = new Date().toISOString();
            
            localStorage.setItem('memorial_draft', JSON.stringify(draftData));
            HebrewMemorialApp.showSuccess('הטיוטה נשמרה בהצלחה');
        });
    }

    // Load draft on page load
    const savedDraft = localStorage.getItem('memorial_draft');
    if (savedDraft) {
        try {
            const draftData = JSON.parse(savedDraft);
            
            // Show option to restore draft
            const restoreDraftHtml = `
                <div class="alert alert-info alert-dismissible fade show hebrew-text" role="alert">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    נמצאה טיוטה שמורה מ${new Date(draftData.timestamp).toLocaleString('he-IL')}.
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="restore-draft">
                        שחזר טיוטה
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="סגור"></button>
                </div>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertAdjacentHTML('afterbegin', restoreDraftHtml);
            
            document.getElementById('restore-draft').addEventListener('click', function() {
                // Restore form data
                Object.keys(draftData).forEach(key => {
                    if (key !== 'timestamp') {
                        const input = document.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = Boolean(draftData[key]);
                            } else {
                                input.value = draftData[key];
                            }
                        }
                    }
                });
                
                // Remove draft notification
                this.closest('.alert').remove();
                
                HebrewMemorialApp.showSuccess('הטיוטה שוחזרה בהצלחה');
            });
            
        } catch (e) {
            console.error('Error loading draft:', e);
        }
    }
});
</script>
{% endblock %}